{% extends 'base.html' %}

{% block meta %}
<title>Register - Football Product</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
    <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
        <div class="max-w-md w-full relative z-10">
            <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
                    <p class="text-gray-500">Create your Football Product account</p>
                </div>

                <div id="ajaxMessages" class="mb-6"></div>

                <form id="registerForm" class="space-y-5">
                    {% csrf_token %}

                    <div>
                        <label for="id_username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input id="id_username" name="username" type="text" required class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" placeholder="Choose a username">
                    </div>

                    <div>
                        <label for="id_password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input id="id_password1" name="password1" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" placeholder="Create a password">
                    </div>

                    <div>
                        <label for="id_password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input id="id_password2" name="password2" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" placeholder="Confirm your password">
                    </div>

                    <button type="submit" id="registerSubmitBtn" class="w-full bg-green-600 text-white font-medium py-3 px-4 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200"> 
                        Create Account 
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-gray-500 text-sm"> Already have an account? 
                        <a href="{% url 'main:login' %}" class="text-green-600 hover:text-green-700 font-medium"> Sign In </a> 
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showToast(message, type = 'success') {
        const color = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : (type === 'info' ? 'bg-blue-600' : 'bg-gray-600'));
        
        let toast = document.createElement('div');
        toast.className = `fixed bottom-5 right-5 z-50 p-4 rounded-lg text-white shadow-lg transition-transform duration-500 transform translate-y-full ${color}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('translate-y-full');
        }, 50);

        setTimeout(() => {
            toast.classList.add('translate-y-full');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    
    function displayDjangoFormErrors(errors) {
        let errorHtml = '';
        for (const field in errors) {
            let fieldName = field;
            if (field === 'username') fieldName = 'Username';
            else if (field === 'password1' || field === 'password2') fieldName = 'Password';
            else if (field === '__all__') fieldName = 'General Error';
            else fieldName = field.charAt(0).toUpperCase() + field.slice(1); // Kapitalisasi sisanya
            
            errors[field].forEach(error => {
                errorHtml += `
                    <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                        <strong>${fieldName}:</strong> ${error}
                    </div>
                `;
            });
        }
        document.getElementById('ajaxMessages').innerHTML = errorHtml;
    }

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const submitBtn = document.getElementById('registerSubmitBtn');
        const registerUrl = window.location.href; 
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating Account...';
        document.getElementById('ajaxMessages').innerHTML = '';
        
        try {
            const response = await fetch(registerUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', 
                }
            });
            
            const responseData = await response.json(); 

            if (response.ok) {
                showToast(responseData.message, 'success');
                setTimeout(() => {
                    window.location.href = responseData.redirect_url;
                }, 500);
            } else {
                const errorMsg = responseData.message || 'Registration failed.';
                showToast(errorMsg, 'error');
                
                if (responseData.errors) {
                    displayDjangoFormErrors(responseData.errors);
                } else {
                    document.getElementById('ajaxMessages').innerHTML = `
                        <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700">
                            ${errorMsg}
                        </div>
                    `;
                }
            }

        } catch (error) {
            console.error('AJAX Catch Error:', error);
            showToast('An unexpected error occurred. Check console for details.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        }
    });
</script>
{% endblock content %}

<input id="id_password1" name="password" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" placeholder="Create a password">

<input id="id_password1" name="password1" type="password" required class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" placeholder="Create a password">